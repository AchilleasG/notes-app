{% extends "base.html" %}

{% block title %}{% if note %}Edit Note{% else %}Create Note{% endif %} - Personal Notebook{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .form-container h2 {
        color: var(--text-primary);
        margin-bottom: 32px;
        font-size: 28px;
        font-weight: 600;
        letter-spacing: -0.5px;
    }
    
    .form-group {
        margin-bottom: 24px;
    }
    
    .form-group label {
        display: block;
        color: var(--text-primary);
        font-weight: 500;
        margin-bottom: 8px;
        font-size: 14px;
    }
    
    .form-group input[type="text"],
    .form-group textarea {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        font-size: 15px;
        font-family: inherit;
        transition: all 0.2s ease;
        background: var(--bg-secondary);
        color: var(--text-primary);
    }
    
    .form-group input[type="text"]:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: var(--btn-primary-bg);
        box-shadow: 0 0 0 3px var(--shadow-sm);
    }
    
    .form-group textarea {
        min-height: 300px;
        resize: vertical;
        line-height: 1.6;
    }
    
    .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid var(--border-secondary);
    }
    
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        color: var(--text-primary);
        font-weight: 500;
        font-size: 14px;
    }
    
    .checkbox-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .markdown-toolbar {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        border-bottom: none;
        border-radius: 8px 8px 0 0;
        padding: 10px;
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }
    
    .markdown-toolbar button {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        padding: 7px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        color: var(--text-primary);
        transition: all 0.2s;
        font-weight: 500;
    }
    
    .markdown-toolbar button:hover {
        background: var(--border-secondary);
        border-color: var(--border-hover);
    }
    
    .form-group textarea.with-toolbar {
        border-radius: 0 0 8px 8px;
    }
    
    .markdown-guide {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
        font-size: 14px;
        color: var(--text-secondary);
    }
    
    .markdown-guide h3 {
        margin: 0 0 12px 0;
        color: var(--text-primary);
        font-size: 16px;
        font-weight: 600;
    }
    
    .markdown-guide code {
        background: var(--bg-secondary);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Courier New', monospace;
        font-size: 13px;
    }
    
    .markdown-guide ul {
        margin: 0;
        padding-left: 24px;
    }
    
    .markdown-guide li {
        margin-bottom: 6px;
    }
    
    .toggle-guide {
        background: transparent;
        border: none;
        color: #1a1a1a;
        cursor: pointer;
        font-size: 14px;
        text-decoration: underline;
        padding: 0;
        margin-bottom: 12px;
        font-weight: 500;
    }
    
    .toggle-guide:hover {
        color: #666;
    }
    
    .file-upload-group {
        margin-top: 12px;
    }
    
    .file-upload-group input[type="file"] {
        display: block;
        margin-top: 8px;
        font-size: 14px;
    }
    
    .file-upload-hint {
        font-size: 13px;
        color: #999;
        margin-top: 8px;
    }
    
    .form-group input[type="password"] {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #e8e8e8;
        border-radius: 8px;
        font-size: 15px;
        transition: all 0.2s ease;
    }
    
    .form-group input[type="password"]:focus {
        outline: none;
        border-color: #1a1a1a;
        box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.05);
    }
    
    .form-group small {
        color: #999;
        font-size: 13px;
        display: block;
        margin-top: 6px;
    }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <h2>{% if note %}Edit Note{% else %}Create New Note{% endif %}</h2>
    
    <button type="button" class="toggle-guide" onclick="toggleGuide()">üìñ Show Markdown Guide</button>
    <div id="markdownGuide" class="markdown-guide" style="display: none;">
        <h3>Markdown Formatting Guide</h3>
        <ul>
            <li><strong>Headers:</strong> <code># H1</code>, <code>## H2</code>, <code>### H3</code></li>
            <li><strong>Bold:</strong> <code>**bold text**</code></li>
            <li><strong>Italic:</strong> <code>*italic text*</code></li>
            <li><strong>Bullet List:</strong> <code>- Item</code> or <code>* Item</code></li>
            <li><strong>Numbered List:</strong> <code>1. Item</code></li>
            <li><strong>Checkbox:</strong> <code>- [ ] Unchecked</code>, <code>- [x] Checked</code></li>
            <li><strong>Link:</strong> <code>[text](url)</code></li>
            <li><strong>Image:</strong> <code>![alt text](url)</code></li>
            <li><strong>Table:</strong> <code>| Header | Header |</code> then <code>| --- | --- |</code> then <code>| Cell | Cell |</code></li>
            <li><strong>Code:</strong> <code>`inline code`</code> or <code>```code block```</code></li>
        </ul>
    </div>
    
    <form method="post" id="noteForm" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="title" name="title" value="{{ note.title|default:'' }}" required>
        </div>
        <div class="form-group">
            <label for="content">Content (Markdown supported)</label>
            <div class="markdown-toolbar">
                <button type="button" onclick="insertMarkdown('**', '**')" title="Bold">B</button>
                <button type="button" onclick="insertMarkdown('*', '*')" title="Italic">I</button>
                <button type="button" onclick="insertMarkdown('# ', '')" title="Heading 1">H1</button>
                <button type="button" onclick="insertMarkdown('## ', '')" title="Heading 2">H2</button>
                <button type="button" onclick="insertMarkdown('### ', '')" title="Heading 3">H3</button>
                <button type="button" onclick="insertMarkdown('- ', '')" title="Bullet point">‚Ä¢ List</button>
                <button type="button" onclick="insertMarkdown('- [ ] ', '')" title="Checkbox">‚òê Checkbox</button>
                <button type="button" onclick="insertMarkdown('[', '](url)')" title="Link">üîó Link</button>
                <button type="button" onclick="insertMarkdown('![', '](url)')" title="Image">üñºÔ∏è Image</button>
                <button type="button" onclick="insertTable()" title="Table">üìä Table</button>
                <button type="button" onclick="insertMarkdown('`', '`')" title="Code">&lt;/&gt; Code</button>
            </div>
            <textarea id="content" name="content" class="with-toolbar" required>{{ note.content|default:'' }}</textarea>
            <div class="file-upload-group">
                <label for="image">Upload Image (optional):</label>
                <input type="file" id="image" name="image" accept="image/*">
                <div class="file-upload-hint">Supported formats: JPG, PNG, GIF. Uploaded images will be stored locally.</div>
            </div>
        </div>
        {% if not note or not note.is_locked %}
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="is_locked" name="is_locked" {% if is_locked %}checked{% endif %}>
                <span>üîí Lock this note (requires password)</span>
            </label>
        </div>
        <div class="form-group" id="passwordGroup" style="display: {% if is_locked %}block{% else %}none{% endif %};">
            <label for="lock_password">Lock Password</label>
            <input type="password" id="lock_password" name="lock_password" placeholder="Enter password to encrypt this note">
            <small style="color: #718096; display: block; margin-top: 5px;">
                This password will be used to encrypt your note. You'll need it to unlock and view the note later.
            </small>
        </div>
        {% endif %}
        <div class="form-actions">
            <button type="submit" class="btn btn-success">{% if note %}Update Note{% else %}Create Note{% endif %}</button>
            <a href="{% url 'note_list' %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
    // Toggle markdown guide
    function toggleGuide() {
        const guide = document.getElementById('markdownGuide');
        const btn = document.querySelector('.toggle-guide');
        if (guide.style.display === 'none') {
            guide.style.display = 'block';
            btn.textContent = 'üìñ Hide Markdown Guide';
        } else {
            guide.style.display = 'none';
            btn.textContent = 'üìñ Show Markdown Guide';
        }
    }
    
    // Insert markdown syntax
    function insertMarkdown(before, after) {
        const textarea = document.getElementById('content');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        const newText = before + (selectedText || 'text') + after;
        
        textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
        
        // Set cursor position
        const newCursorPos = start + before.length + (selectedText ? selectedText.length : 0);
        textarea.setSelectionRange(newCursorPos, newCursorPos);
        textarea.focus();
    }
    
    // Insert table template
    function insertTable() {
        const table = '\n| Header 1 | Header 2 | Header 3 |\n| -------- | -------- | -------- |\n| Cell 1   | Cell 2   | Cell 3   |\n| Cell 4   | Cell 5   | Cell 6   |\n';
        const textarea = document.getElementById('content');
        const start = textarea.selectionStart;
        textarea.value = textarea.value.substring(0, start) + table + textarea.value.substring(start);
        textarea.focus();
    }
    
    // Handle image upload and insert markdown
    document.getElementById('image').addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            const fileName = e.target.files[0].name;
            const textarea = document.getElementById('content');
            const imageMarkdown = '\n![' + fileName + '](/media/note_images/' + fileName + ')\n';
            textarea.value += imageMarkdown;
        }
    });
    
    // Lock checkbox handler
    const isLockedCheckbox = document.getElementById('is_locked');
    if (isLockedCheckbox) {
        isLockedCheckbox.addEventListener('change', function() {
            document.getElementById('passwordGroup').style.display = this.checked ? 'block' : 'none';
            document.getElementById('lock_password').required = this.checked;
        });
    }

    // Client-side encryption
    class NoteEncryption {
        constructor() {
            this.algorithm = 'AES-GCM';
            this.keyLength = 256;
            this.ivLength = 12;
            this.saltLength = 16;
            this.iterations = 100000;
        }

        generateSalt() {
            return crypto.getRandomValues(new Uint8Array(this.saltLength));
        }

        generateIV() {
            return crypto.getRandomValues(new Uint8Array(this.ivLength));
        }

        async deriveKey(password, salt) {
            const encoder = new TextEncoder();
            const passwordKey = await crypto.subtle.importKey(
                'raw',
                encoder.encode(password),
                'PBKDF2',
                false,
                ['deriveKey']
            );

            return crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: this.iterations,
                    hash: 'SHA-256'
                },
                passwordKey,
                {
                    name: this.algorithm,
                    length: this.keyLength
                },
                false,
                ['encrypt']
            );
        }

        async encrypt(text, password) {
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(text);
                
                const salt = this.generateSalt();
                const iv = this.generateIV();
                const key = await this.deriveKey(password, salt);

                const encryptedData = await crypto.subtle.encrypt(
                    {
                        name: this.algorithm,
                        iv: iv
                    },
                    key,
                    data
                );

                // Combine only iv + encrypted data (salt stored separately)
                const result = new Uint8Array(iv.length + encryptedData.byteLength);
                result.set(iv, 0);
                result.set(new Uint8Array(encryptedData), iv.length);

                return {
                    encrypted: btoa(String.fromCharCode(...result)),
                    salt: Array.from(salt).map(b => b.toString(16).padStart(2, '0')).join('')
                };
            } catch (error) {
                console.error('Encryption failed:', error);
                throw new Error('Failed to encrypt content');
            }
        }
    }

    const noteEncryption = new NoteEncryption();

    // Handle form submission with encryption
    document.getElementById('noteForm').addEventListener('submit', async function(e) {
        const isLocked = document.getElementById('is_locked');
        const password = document.getElementById('lock_password');
        const content = document.getElementById('content');
        
        if (isLocked && isLocked.checked && password && password.value) {
            e.preventDefault(); // Stop the normal form submission
            
            try {
                // Encrypt the content
                const result = await noteEncryption.encrypt(content.value, password.value);
                
                // Create hidden fields for encrypted data
                let encryptedContentField = document.getElementById('encrypted_content');
                let saltField = document.getElementById('salt_field');
                
                if (!encryptedContentField) {
                    encryptedContentField = document.createElement('input');
                    encryptedContentField.type = 'hidden';
                    encryptedContentField.name = 'encrypted_content';
                    encryptedContentField.id = 'encrypted_content';
                    this.appendChild(encryptedContentField);
                }
                
                if (!saltField) {
                    saltField = document.createElement('input');
                    saltField.type = 'hidden';
                    saltField.name = 'salt';
                    saltField.id = 'salt_field';
                    this.appendChild(saltField);
                }
                
                // Set the encrypted values
                encryptedContentField.value = result.encrypted;
                saltField.value = result.salt;
                
                // Clear the original content field (we'll send encrypted instead)
                content.value = '';
                
                // Clear the password field (don't send password to server)
                password.value = '';
                
                // Now submit the form
                this.submit();
            } catch (error) {
                alert('Encryption failed: ' + error.message);
            }
        }
        // If not locked or no password, submit normally
    });
</script>
{% endblock %}
