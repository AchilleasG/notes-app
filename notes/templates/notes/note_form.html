{% extends "base.html" %}

{% block title %}{% if note %}Edit Note{% else %}Create Note{% endif %} - Personal Notebook{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        max-width: 800px;
        margin: 0 auto;
    }
    .form-container h2 {
        color: #2d3748;
        margin-bottom: 30px;
        font-size: 24px;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        color: #2d3748;
        font-weight: 600;
        margin-bottom: 8px;
    }
    .form-group input[type="text"],
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #cbd5e0;
        border-radius: 5px;
        font-size: 14px;
        font-family: inherit;
        transition: border-color 0.3s;
    }
    .form-group input[type="text"]:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .form-group textarea {
        min-height: 200px;
        resize: vertical;
    }
    .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 30px;
    }
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        color: #2d3748;
        font-weight: 600;
    }
    .checkbox-label input[type="checkbox"] {
        width: auto;
        cursor: pointer;
    }
    .markdown-toolbar {
        background: #f7fafc;
        border: 1px solid #cbd5e0;
        border-bottom: none;
        border-radius: 5px 5px 0 0;
        padding: 8px;
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
    }
    .markdown-toolbar button {
        background: white;
        border: 1px solid #cbd5e0;
        padding: 6px 12px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 13px;
        color: #2d3748;
        transition: all 0.2s;
    }
    .markdown-toolbar button:hover {
        background: #edf2f7;
        border-color: #667eea;
    }
    .form-group textarea.with-toolbar {
        border-radius: 0 0 5px 5px;
    }
    .markdown-guide {
        background: #edf2f7;
        border: 1px solid #cbd5e0;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        font-size: 13px;
        color: #4a5568;
    }
    .markdown-guide h3 {
        margin: 0 0 10px 0;
        color: #2d3748;
        font-size: 16px;
    }
    .markdown-guide code {
        background: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
    }
    .markdown-guide ul {
        margin: 0;
        padding-left: 20px;
    }
    .markdown-guide li {
        margin-bottom: 4px;
    }
    .toggle-guide {
        background: transparent;
        border: none;
        color: #667eea;
        cursor: pointer;
        font-size: 13px;
        text-decoration: underline;
        padding: 0;
        margin-bottom: 10px;
    }
    .toggle-guide:hover {
        color: #5568d3;
    }
    .file-upload-group {
        margin-top: 10px;
    }
    .file-upload-group input[type="file"] {
        display: block;
        margin-top: 5px;
        font-size: 13px;
    }
    .file-upload-hint {
        font-size: 12px;
        color: #718096;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <h2>{% if note %}Edit Note{% else %}Create New Note{% endif %}</h2>
    
    <button type="button" class="toggle-guide" onclick="toggleGuide()">üìñ Show Markdown Guide</button>
    <div id="markdownGuide" class="markdown-guide" style="display: none;">
        <h3>Markdown Formatting Guide</h3>
        <ul>
            <li><strong>Headers:</strong> <code># H1</code>, <code>## H2</code>, <code>### H3</code></li>
            <li><strong>Bold:</strong> <code>**bold text**</code></li>
            <li><strong>Italic:</strong> <code>*italic text*</code></li>
            <li><strong>Bullet List:</strong> <code>- Item</code> or <code>* Item</code></li>
            <li><strong>Numbered List:</strong> <code>1. Item</code></li>
            <li><strong>Checkbox:</strong> <code>- [ ] Unchecked</code>, <code>- [x] Checked</code></li>
            <li><strong>Link:</strong> <code>[text](url)</code></li>
            <li><strong>Image:</strong> <code>![alt text](url)</code></li>
            <li><strong>Table:</strong> <code>| Header | Header |</code> then <code>| --- | --- |</code> then <code>| Cell | Cell |</code></li>
            <li><strong>Code:</strong> <code>`inline code`</code> or <code>```code block```</code></li>
        </ul>
    </div>
    
    <form method="post" id="noteForm" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-group">
            <label for="title">Title</label>
            <input type="text" id="title" name="title" value="{{ note.title|default:'' }}" required>
        </div>
        <div class="form-group">
            <label for="content">Content (Markdown supported)</label>
            <div class="markdown-toolbar">
                <button type="button" onclick="insertMarkdown('**', '**')" title="Bold">B</button>
                <button type="button" onclick="insertMarkdown('*', '*')" title="Italic">I</button>
                <button type="button" onclick="insertMarkdown('# ', '')" title="Heading 1">H1</button>
                <button type="button" onclick="insertMarkdown('## ', '')" title="Heading 2">H2</button>
                <button type="button" onclick="insertMarkdown('### ', '')" title="Heading 3">H3</button>
                <button type="button" onclick="insertMarkdown('- ', '')" title="Bullet point">‚Ä¢ List</button>
                <button type="button" onclick="insertMarkdown('- [ ] ', '')" title="Checkbox">‚òê Checkbox</button>
                <button type="button" onclick="insertMarkdown('[', '](url)')" title="Link">üîó Link</button>
                <button type="button" onclick="insertMarkdown('![', '](url)')" title="Image">üñºÔ∏è Image</button>
                <button type="button" onclick="insertTable()" title="Table">üìä Table</button>
                <button type="button" onclick="insertMarkdown('`', '`')" title="Code">&lt;/&gt; Code</button>
            </div>
            <textarea id="content" name="content" class="with-toolbar" required>{{ note.content|default:'' }}</textarea>
            <div class="file-upload-group">
                <label for="image">Upload Image (optional):</label>
                <input type="file" id="image" name="image" accept="image/*">
                <div class="file-upload-hint">Supported formats: JPG, PNG, GIF. Uploaded images will be stored locally.</div>
            </div>
        </div>
        {% if not note or not note.is_locked %}
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="is_locked" name="is_locked" {% if is_locked %}checked{% endif %}>
                <span>üîí Lock this note (requires password)</span>
            </label>
        </div>
        <div class="form-group" id="passwordGroup" style="display: {% if is_locked %}block{% else %}none{% endif %};">
            <label for="lock_password">Lock Password</label>
            <input type="password" id="lock_password" name="lock_password" placeholder="Enter password to encrypt this note">
            <small style="color: #718096; display: block; margin-top: 5px;">
                This password will be used to encrypt your note. You'll need it to unlock and view the note later.
            </small>
        </div>
        {% endif %}
        <div class="form-actions">
            <button type="submit" class="btn btn-success">{% if note %}Update Note{% else %}Create Note{% endif %}</button>
            <a href="{% url 'note_list' %}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
    // Toggle markdown guide
    function toggleGuide() {
        const guide = document.getElementById('markdownGuide');
        const btn = document.querySelector('.toggle-guide');
        if (guide.style.display === 'none') {
            guide.style.display = 'block';
            btn.textContent = 'üìñ Hide Markdown Guide';
        } else {
            guide.style.display = 'none';
            btn.textContent = 'üìñ Show Markdown Guide';
        }
    }
    
    // Insert markdown syntax
    function insertMarkdown(before, after) {
        const textarea = document.getElementById('content');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        const newText = before + (selectedText || 'text') + after;
        
        textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
        
        // Set cursor position
        const newCursorPos = start + before.length + (selectedText ? selectedText.length : 0);
        textarea.setSelectionRange(newCursorPos, newCursorPos);
        textarea.focus();
    }
    
    // Insert table template
    function insertTable() {
        const table = '\n| Header 1 | Header 2 | Header 3 |\n| -------- | -------- | -------- |\n| Cell 1   | Cell 2   | Cell 3   |\n| Cell 4   | Cell 5   | Cell 6   |\n';
        const textarea = document.getElementById('content');
        const start = textarea.selectionStart;
        textarea.value = textarea.value.substring(0, start) + table + textarea.value.substring(start);
        textarea.focus();
    }
    
    // Handle image upload and insert markdown
    document.getElementById('image').addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            const fileName = e.target.files[0].name;
            const textarea = document.getElementById('content');
            const imageMarkdown = '\n![' + fileName + '](/media/note_images/' + fileName + ')\n';
            textarea.value += imageMarkdown;
        }
    });
    
    // Lock checkbox handler
    const isLockedCheckbox = document.getElementById('is_locked');
    if (isLockedCheckbox) {
        isLockedCheckbox.addEventListener('change', function() {
            document.getElementById('passwordGroup').style.display = this.checked ? 'block' : 'none';
            document.getElementById('lock_password').required = this.checked;
        });
    }
</script>
{% endblock %}
