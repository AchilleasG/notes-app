{% extends "base.html" %}

{% block title %}History - {{ note.title }} - Personal Notebook{% endblock %}

{% block extra_css %}
<style>
    .history-container {
        max-width: 900px;
        margin: 0 auto;
    }
    
    .history-header {
        margin-bottom: 32px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border-secondary);
    }
    
    .history-title {
        color: var(--text-primary);
        font-size: 32px;
        margin-bottom: 12px;
        word-wrap: break-word;
        font-weight: 600;
        letter-spacing: -0.5px;
    }
    
    .history-title .lock-badge {
        font-size: 24px;
        margin-right: 8px;
    }
    
    .timeline {
        position: relative;
        padding-left: 40px;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border-secondary);
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 24px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 12px;
        padding: 24px;
        transition: all 0.2s ease;
    }
    
    .timeline-item:hover {
        box-shadow: 0 4px 16px var(--shadow-md);
        transform: translateY(-2px);
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -34px;
        top: 30px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--btn-primary-bg);
        border: 3px solid var(--bg-secondary);
        box-shadow: 0 0 0 2px var(--btn-primary-bg);
    }
    
    .version-date {
        font-size: 13px;
        color: var(--text-tertiary);
        font-weight: 500;
        margin-bottom: 12px;
    }
    
    .version-title {
        font-size: 18px;
        color: var(--text-primary);
        margin-bottom: 12px;
        font-weight: 600;
    }
    
    .version-content {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        padding: 16px;
        white-space: pre-wrap;
        line-height: 1.6;
        color: var(--text-secondary);
        max-height: 200px;
        overflow-y: auto;
        font-size: 14px;
    }
    
    .current-version {
        border: 2px solid #10b981;
        background: #f0fdf4;
    }
    
    .current-version::before {
        background: #10b981;
        box-shadow: 0 0 0 2px #10b981;
    }
    
    .current-badge {
        display: inline-block;
        background: #10b981;
        color: white;
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 10px;
        letter-spacing: 0.5px;
    }
    
    .empty-history {
        text-align: center;
        padding: 80px 20px;
        color: #666;
    }
    
    .empty-history-icon {
        font-size: 64px;
        margin-bottom: 24px;
        opacity: 0.5;
    }
    
    .empty-history h3 {
        font-size: 24px;
        color: #1a1a1a;
        margin-bottom: 12px;
        font-weight: 600;
    }
    
    .empty-history p {
        color: #666;
        line-height: 1.6;
    }
    
    .back-actions {
        margin-bottom: 32px;
    }

    /* Password modal styles */
    .password-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
    }

    .password-modal.hidden {
        display: none;
    }

    .password-modal-content {
        background: var(--bg-primary);
        padding: 32px;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
    }

    .password-modal-content h3 {
        color: var(--text-primary);
        margin: 0 0 12px 0;
        font-size: 24px;
    }

    .password-modal-content p {
        color: var(--text-secondary);
        margin: 0 0 20px 0;
        font-size: 14px;
    }

    .password-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        font-size: 15px;
        margin-bottom: 20px;
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    .password-input:focus {
        outline: none;
        border-color: var(--btn-primary-bg);
        box-shadow: 0 0 0 3px var(--shadow-sm);
    }

    .password-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .decrypt-button {
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="history-container">
    <div class="history-header">
        <h1 class="history-title">
            {% if note.is_locked %}<span class="lock-badge">üîí</span>{% endif %}
            History: {{ note.title }}
        </h1>
    </div>
    
    <div class="back-actions">
        <a href="{% url 'note_view' note.pk %}" class="btn btn-secondary">‚Üê Back to Note</a>
        {% if note.is_locked %}
        <button class="btn btn-primary decrypt-button" onclick="showPasswordModal()">üîì Decrypt History</button>
        {% endif %}
    </div>

    {% if versions %}
        <div class="timeline">
            <!-- Current version -->
            <div class="timeline-item current-version">
                <div class="version-date">
                    {{ note.updated_at|date:"M d, Y H:i" }}
                    <span class="current-badge">CURRENT VERSION</span>
                </div>
                <div class="version-title">{{ note.title }}</div>
                <div class="version-content" id="current-content" data-encrypted="{{ note.content|escapejs }}" data-is-locked="{{ note.is_locked|lower }}" data-salt="{{ note.salt|escapejs }}">
                    {% if note.is_locked %}
                        <em>üîí Encrypted content - click "Decrypt History" to view</em>
                    {% else %}
                        {{ note.content }}
                    {% endif %}
                </div>
            </div>

            <!-- Historical versions -->
            {% for version in versions %}
            <div class="timeline-item">
                <div class="version-date">
                    {{ version.created_at|date:"M d, Y H:i" }}
                </div>
                <div class="version-title">
                    {{ version.title }}
                    {% if version.is_locked %}<span class="lock-badge">üîí</span>{% endif %}
                </div>
                <div class="version-content version-{{ forloop.counter }}" data-encrypted="{{ version.content|escapejs }}" data-is-locked="{{ version.is_locked|lower }}" data-salt="{{ version.salt|escapejs }}">
                    {% if version.is_locked %}
                        <em>üîí Encrypted content - click "Decrypt History" to view</em>
                    {% else %}
                        {{ version.content }}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-history">
            <div class="empty-history-icon">üìú</div>
            <h3>No version history yet</h3>
            <p>Version history will appear here after you edit this note.</p>
        </div>
    {% endif %}
</div>

<!-- Password Modal for decryption -->
{% if note.is_locked or versions|length > 0 %}
<div id="passwordModal" class="password-modal hidden">
    <div class="password-modal-content">
        <h3>üîí Enter Password</h3>
        <p>Enter the password to decrypt the history of this note</p>
        <input type="password" id="passwordInput" class="password-input" placeholder="Enter password" />
        <div class="password-buttons">
            <button class="btn btn-secondary" onclick="hidePasswordModal()">Cancel</button>
            <button class="btn btn-primary" onclick="decryptHistory()">Decrypt</button>
        </div>
    </div>
</div>

<script>
/**
 * Client-side encryption/decryption for note history
 */
class NoteEncryption {
    constructor() {
        this.passwordCache = new Map();
        this.algorithm = 'AES-GCM';
        this.keyLength = 256;
        this.ivLength = 12;
        this.saltLength = 16;
        this.iterations = 100000;
    }

    generateSalt() {
        return crypto.getRandomValues(new Uint8Array(this.saltLength));
    }

    generateIV() {
        return crypto.getRandomValues(new Uint8Array(this.ivLength));
    }

    async deriveKey(password, salt) {
        const encoder = new TextEncoder();
        const passwordKey = await crypto.subtle.importKey(
            'raw',
            encoder.encode(password),
            'PBKDF2',
            false,
            ['deriveKey']
        );

        return crypto.subtle.deriveKey(
            {
                name: 'PBKDF2',
                salt: salt,
                iterations: this.iterations,
                hash: 'SHA-256'
            },
            passwordKey,
            {
                name: this.algorithm,
                length: this.keyLength
            },
            false,
            ['encrypt', 'decrypt']
        );
    }

    async decrypt(encryptedText, password, saltHex) {
        try {
            const combined = new Uint8Array(atob(encryptedText).split('').map(c => c.charCodeAt(0)));
            const salt = new Uint8Array(saltHex.match(/.{2}/g).map(byte => parseInt(byte, 16)));
            const iv = combined.slice(this.saltLength, this.saltLength + this.ivLength);
            const encryptedData = combined.slice(this.saltLength + this.ivLength);
            const key = await this.deriveKey(password, salt);

            const decryptedData = await crypto.subtle.decrypt(
                {
                    name: this.algorithm,
                    iv: iv
                },
                key,
                encryptedData
            );

            const decoder = new TextDecoder();
            return decoder.decode(decryptedData);
        } catch (error) {
            console.error('Decryption failed:', error);
            throw new Error('Failed to decrypt content - wrong password?');
        }
    }

    cachePassword(noteId, password) {
        this.passwordCache.set(noteId, password);
    }

    getCachedPassword(noteId) {
        return this.passwordCache.get(noteId);
    }
}

const noteEncryption = new NoteEncryption();

// Note data
const noteData = {
    id: {{ note.pk }},
    is_locked: {{ note.is_locked|lower }}
};

window.showPasswordModal = function() {
    document.getElementById('passwordModal').classList.remove('hidden');
    document.getElementById('passwordInput').focus();
}

window.hidePasswordModal = function() {
    document.getElementById('passwordModal').classList.add('hidden');
    document.getElementById('passwordInput').value = '';
}

window.decryptHistory = async function() {
    const password = document.getElementById('passwordInput').value;
    
    if (!password) {
        alert('Please enter a password');
        return;
    }

    try {
        // Decrypt all encrypted content elements
        const contentElements = document.querySelectorAll('.version-content[data-is-locked="true"]');
        let decryptionSuccess = false;

        for (const element of contentElements) {
            const encryptedContent = element.dataset.encrypted;
            const salt = element.dataset.salt;
            
            if (encryptedContent && salt) {
                try {
                    const decryptedContent = await noteEncryption.decrypt(encryptedContent, password, salt);
                    element.innerHTML = '<pre style="white-space: pre-wrap; margin: 0; font-family: inherit;">' + escapeHtml(decryptedContent) + '</pre>';
                    decryptionSuccess = true;
                } catch (error) {
                    console.error('Failed to decrypt version:', error);
                }
            }
        }

        if (decryptionSuccess) {
            // Cache the password
            noteEncryption.cachePassword(noteData.id, password);
            hidePasswordModal();
            
            // Hide the decrypt button
            const decryptButton = document.querySelector('.decrypt-button');
            if (decryptButton) {
                decryptButton.style.display = 'none';
            }
        } else {
            alert('Decryption failed. Wrong password?');
        }
    } catch (error) {
        console.error('Decryption error:', error);
        alert('Decryption failed: ' + error.message);
    }
}

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Auto-decrypt if we have a cached password
(async function() {
    if (noteData.is_locked) {
        const cachedPassword = noteEncryption.getCachedPassword(noteData.id);
        if (cachedPassword) {
            document.getElementById('passwordInput').value = cachedPassword;
            await decryptHistory();
        }
    }
})();

// Allow pressing Enter in password field to decrypt
document.getElementById('passwordInput')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        decryptHistory();
    }
});
</script>
{% endif %}

{% endblock %}
